---
title: "Semin√°rio LoggingLab"
subtitle: "Um pacote R para simular o corte seletivo de impacto reduzido em florestas tropicais"
author: "Sylvain Schmitt & G√©raldine Derroire"
institute: CIRAD
date: today
date-format: medium
format: 
  revealjs:
    theme: dark
    output-location: fragment
    slide-number: true
    logo: figs/logo.png
    transition: fade
    preview-links: true
    chalkboard: true
bibliography: references.bib
---

```{r}
set.seed(24)
```


# Introdu√ß√£o

O pacote LoggingLab do R, desenvolvido no contexto da extra√ß√£o seletiva de madeira na Guiana Francesa, permite que cada est√°gio da extra√ß√£o seletiva de madeira seja simulado de forma espacialmente expl√≠cita. Isso permite que os efeitos de diferentes pr√°ticas de explora√ß√£o madeireira no ecossistema sejam avaliados e comparados com precis√£o. O objetivo desse workshop pr√°tico ser√° apresentar e usar em conjunto as fun√ß√µes gerais desse pacote.

::: notes
Notas.
:::

## O que o pacote faz?

Simula√ß√£o de corte seletivo usando dados de invent√°rio florestal.

![](https://ars.els-cdn.com/content/image/1-s2.0-S0304380023002697-ga1_lrg.jpg)

::: notes
Notas.
:::

## O que o pacote faz?

::: columns
::: {.column width="30%"}
![](figs/Fig_Flowchart.jpg)
:::

::: {.column width="70%"}
Os est√°gios s√£o:

-   prepara√ß√£o de dados
-   trilhas principais
-   zonas explor√°veis
-   sele√ß√£o de √°rvores
-   trilhas de arraste
-   corte de √°rvores
-   quantifica√ß√£o de volumes
:::
:::

::: notes
Notas.
:::

## Instala√ß√£o do pacote

Usaremos o pacote LoggingLab para R [@Badouard2024] para simular a extra√ß√£o de madeira de impacto reduzido em uma floresta tropical. O pacote deve ser instalado a partir de seu reposit√≥rio no Github, pois ainda n√£o est√° no CRAN.

```{r install}
#| eval: false
#| echo: true
install.packages("devtools")
devtools::install_github("VincyaneBadouard/LoggingLab")
```

::: notes
Notas.
:::

## Outros pacotes R

Usaremos o `tidyverse` para manipular tabelas e criar gr√°ficos, o `sf` para manipular objetos espaciais e o `terra` e o `tidyterra` para manipular dados raster.

```{r libs}
#| echo: true
library(LoggingLab)
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
theme_set(theme_bw())
```

::: notes
Notas.
:::

# Entradas

Os dados e par√¢metros necess√°rios para usar `LoggingLab` s√£o as seguintes:

-   **Invent√°rio**: invent√°rios de √°rvores da parcela
-   **M√°scara do lote**: os limites da √°rea a ser explorada
-   **Dados da esp√©cie**: dados espec√≠ficos para cada esp√©cie
-   **Alometria volum√©trica**: os par√¢metros de alometria a serem calculados

::: notes
Notas.
:::

## Invent√°rio

O invent√°rio deve conter o di√¢metro, a a identifica√ß√£o bot√¢nica e as coordenadas de todos os arvores com menos de um determinado di√¢metro (normalmente DAP \>= 10cm).

No momento, o simulador est√° trabalhando em pequenos lotes (alguns hectares) e n√£o representa toda a opera√ß√£o de uma concess√£o, pois seu foco √© a quantifica√ß√£o detalhada dos danos p√≥s-operacionais de acordo com as pr√°ticas.

::: notes
DAP: diametro a altura do peito
:::

## Invent√°rio

As colunas exigidas pelo `LoggingLab` s√£o:

::: incremental
-   `Forest`: o nome da floresta
-   `idTree`: um identificador exclusivo para cada √°rvore
-   `Xutm` e `Yutm`: as coordenadas de cada √°rvore
-   `CodeAlive`: √°rvore viva ou morta.
-   `Family`, `Genus`, `Species`: dados bot√¢nicos
-   `CircCorr`: circunfer√™ncia de cada √°rvore
:::

::: notes
Notas.
:::

## Invent√°rio

O invent√°rio do lote 6 de Paracou est√° dispon√≠vel dentro `LoggingLab`.

```{r p6}
#| echo: true
head(Paracou6_2016)
```

::: notes
Notas.
:::

## Invent√°rio

Podemos fazer um mapa do lote 6 de Paraou em 2016.

<!-- GD: for the presentation to the practitionner, I will use a color per species and a size proportunional to the DBH to illustrate all the infos needed. You may want (or not) to do the same here (the code is in fig_pres_pract.qmd)-->

```{r p6plot}
#| echo: true
Paracou6_2016 %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  ggplot() + geom_sf()
```

::: notes
Notas.
:::

## M√°scara do lote

A m√°scara do lote define os limites da √°rea a ser registrada <!-- not sure registrada is the right term... a ser considerada ?--> ou seja, os limites do lote. A m√°scara do lote √© usada pelo `LoggingLab` para validar o invent√°rio e definir a zonas explor√°veis.

::: notes
Notas.
:::

## M√°scara do lote

A m√°scara do lote 6 de Paracou est√° dispon√≠vel dentro `LoggingLab`.

```{r mask}
#| echo: true
ggplot(st_as_sf(PlotMask)) + geom_sf()
```

::: notes
Notas.
:::

## Dados de esp√©cies

`SpeciesCriteria` cont√©m dados espec√≠ficos de cada esp√©cie. As colunas s√£o:

::: incremental
-   `CommercialLevel`: N√≠vel de interesse econ√¥mico
-   `MinFD`: Di√¢metro m√≠nimo de corte, em cent√≠metros
-   `UpMinFD`: Di√¢metro m√≠nimo de corte aprimorado (caso de povoamento excessivamente rico), em cent√≠metros
-   `MaxFD`: Di√¢metro m√°ximo de corte, em cent√≠metros
-   `Aggregative`: Natureza agregadora da esp√©cie para converter √°rvores isoladas <!-- not sure converter is the right word... evitar ?
    Also, I'm not sure we want to explain this as it may take quite some time and it is not central... what do you think?-->
:::

::: notes
Explain here what are the different level of CommercialLevel, as there may not be different level in Brasil.
:::

## Dados de esp√©cies

Dados de esp√©cies de Guiana Francesa s√£o dispon√≠vel dentro `LoggingLab`.

```{r species}
#| echo: true
head(SpeciesCriteria)
```

::: notes
Notas.
:::

## Alometrias volum√©tricas

O `LoggingLab` usa alometrias volum√©tricas com par√¢metros que variam de acordo com a regi√£o explorada. Por exemplo, por volume de √°rvores que o `LoggingLab` usa:

$$Volume = aCoef + bCoef \times DBH^2$$

Com $Volume$ o volume das √°rvores e $DBH$ o diametro das √°rvores.

::: notes
Notas.
:::

## Alometrias volum√©trica

Alometrias volum√©tricas para diferentes regi√µes da Guiana Francesa s√£o dispon√≠vel dentro `LoggingLab`.

```{r allometry}
#| echo: true
head(ForestZoneVolumeParametersTable)
```

Outras alometrias podem ser modificadas, como as alometrias de coroa.

::: notes
Notas.
:::

# Simula√ß√£o de explora√ß√£o

Agora, vamos executar uma simula√ß√£o de explora√ß√£o passo a passo usando `LoggingLab`.

::: notes
Notas.
:::

## Validar o invent√°rio

As √°rvores que n√£o est√£o na √°rea registrada ou que s√£o muito pequenas para serem consideradas s√£o exclu√≠das.

```{r prep}
#| echo: true
inventory <- inventorycheckformat(Paracou6_2016)
inventory <- cleaninventory(inventory, PlotMask)
```

`inventorycheckformat` verifica se os dados de invent√°rio recebidos s√£o compat√≠veis com o `LoggingLab`, enquanto `cleaninventory` limpa os dados de invent√°rio.

::: notes
Notas.
:::

## Validar o invent√°rio

Como os dados j√° estavam limpos, n√£o houve muitas altera√ß√µes.

```{r prepmap}
#| echo: true
inventory %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  ggplot() + geom_sf()
```

::: notes
Notas.
:::

## Calcular as dimens√µes da √°rvore

Em seguida, o `addtreedim` calcula as dimens√µes da √°rvore (altura da √°rvore, tronco e copa, di√¢metro da copa, volume explor√°vel, densidade da madeira e biomassa).

```{r dims}
#| echo: true
inventory <- addtreedim(inventory, ForestZoneVolumeParametersTable)
head(select(inventory, TreeHarvestableVolume, TrunkHeight, TreeHeight, CrownHeight,
            CrownDiameter, WoodDensity, AGB))
```

::: notes
Notas.
:::

## Calcular as dimens√µes da √°rvore

Por exemplo, podemos elaborar um mapa do volume explor√°vel.

```{r dimsplot}
#| echo: true
inventory %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  ggplot() + geom_sf(aes(col = TreeHarvestableVolume)) + 
  scale_color_viridis_c(trans = "log")
```

```{=html}
<!-- this is good to show it as a map. 
But I wonder if this could lead to confusision as it shows the harvestable volume for all trees, but all trees are not harvestable (may be too small or not commercial)...
Maybe present the biomass ? less informative in the context of logging but would avoid confusion/questions?-->
```
::: notes
Notas.
:::

## Trilhas principais

Como estamos simulando apenas a explora√ß√£o em alguns hectares, n√£o estamos simulando as trilhas principais. Mas precisamos de sua localiza√ß√£o para simular as trilhas de arraste.

O `maintrailextract` gera as trilhas principais da √°rea que est√° sendo explorado usando os bordas de m√°scara do lote.

::: notes
Notas.
:::

## Trilhas principais

```{r maintrail}
#| echo: true
#| cache: true
MainTrails <- maintrailextract(DTMParacou)
ggplot(MainTrails) +
  geom_sf()
```

<!-- I think we should put them in color/bold otherwise this is the same figure than the mask.
In the compiled html, the figure doesnt' show, I don't know why...-->

::: notes
Notas.
:::

## Zonas explor√°veis

Em seguida, precisamos definir as √°reas de colheita e as √°reas acess√≠veis √†s m√°quinas dentro do talh√£o. Por padr√£o, uma unidade de prospec√ß√£o √©:

::: incremental
- uma √°rea conectada a uma trilha de caminh√£o ou trilha principal de skidding
- com uma inclina√ß√£o inferior a 27%
- evitando plan√≠cies e o sistema de √°gua (buffer de 30 m).
::: 

<!-- maybe don't talk about piste √† camions to avoid spending time on vocabulary?--> 

::: notes
Notas.
:::

## Zonas explor√°veis

Usamos `harvestableareadefinition` com uma op√ß√£o ‚Äúwinching‚Äù definida como 2, ou seja, a garra √© usada, se poss√≠vel (extens√£o de 6 m), e o cabo √© usado at√© 40 m.

```{r harvareas}
#| echo: true
#| cache: true
HarvestableArea <- harvestableareadefinition(
  topography = DTMParacou,
  creekverticaldistance = CreekDistances$distvert,
  creekhorizontaldistance = CreekDistances$disthorz,
  maintrails = MainTrails,
  plotmask = PlotMask,
  scenario = "manual",
  winching = "2",
  advancedloggingparameters = loggingparameters()
)
```

::: notes
Notas.
:::

## Zonas explor√°veis {.smaller}

As √°reas verdes claras podem ser colhidas (√°reas verde-escuras podem ser colhidas por m√°quina e verde-claro com cabo). As outras √°reas s√£o as √°reas n√£o explor√°veis (areas baixas com o sistema de √°gua).

<!-- I've tried to make the map more readable-->

```{r harvareasplot}
#| echo: true
(base <- ggplot() +
    geom_spatraster(data = rast(DTMParacou), alpha = .5) +
    scale_fill_gradient(low = "darkblue", high = "white", "Altura (m)", na.value = NA) + 
    geom_sf(data = HarvestableArea$HarvestablePolygons, fill = "darkgreen", alpha = 0.3) +
    geom_sf(data = HarvestableArea$MachinePolygons, fill = "darkgreen", alpha = 0.7))
```

::: notes
Notas.
:::

## Sele√ß√£o de √°rvores {.smaller}

Em seguida, selecionamos as √°rvores a serem colhidas e as √°rvores futuras e de reserva. As √°rvores podem ser colhidas se:

::: incremental
-   Pertencem a esp√©cies de primeira categoria econ√¥mica ou mais, se houver diversifica√ß√£o.

-   O DBH estiver entre o MinFD e o MaxFD.

-   N√£o estiverem isoladas (\>100 m por padr√£o) de outros indiv√≠duos da mesma esp√©cie no caso de esp√©cies agregadas.

-   Est√£o localizadas em declives \< 22%.

-   Est√£o fora das trilhas principais.
:::

<!-- depending on if we decide to talk or not about species aggregation, remove the critera non isoladas, let's decide on this and be consistent with the practicionner presentation-->

As √°rvores a serem colhidas s√£o escolhidas em ordem decrescente de volume, at√© que o volume objetivo seja atingido.

As √°rvores futuras s√£o aqueles a serem explorados na pr√≥xima campanha. 
As √°rvores de reserva s√£o conservadas como √°rvores-semente para regenera√ß√£o natural.

::: notes
Notas.
:::

## Sele√ß√£o de √°rvores {.smaller}

Se o volume extra√≠vel for muito baixo, a diversifica√ß√£o pode ser aplicada (`specieslax = TRUE`): as √°rvores de todas as classifica√ß√µes comerciais s√£o selecionadas em ordem decrescente de volume at√© que o volume objetivo seja atingido, ou a extra√ß√£o pode continuar apesar de um volume objetivo n√£o atingido ou ser abandonada (`objectivelax = FALSE`).

<!-- idem, do we want to talk about "forced" diversification if too poor ? --> 

```{r treesel}
#| echo: true
#| warning: true
inventory <- inventory %>% 
  commercialcriteriajoin(SpeciesCriteria)
TreeSelection <- inventory %>% 
  treeselection(
    topography = DTMParacou,
    speciescriteria = SpeciesCriteria,
    scenario ="manual", 
    objective = 30,
    fuel = "0",
    winching = "2",
    diversification = TRUE, 
    specieslax = FALSE,
    objectivelax = TRUE,
    harvestablearea = HarvestableArea$HarvestableArea,
    plotslope = HarvestableArea$PlotSlope,
    maintrails = MainTrails,
    harvestablepolygons = HarvestableArea$HarvestablePolygons,
    advancedloggingparameters = loggingparameters()
  )
crs <- st_crs(HarvestableArea$HarvestablePolygons)
```

<!-- IMPORTANT COMMENT: here I would not simulate fuel wood, as discussed. So put fuel="0", as you do for the trail layout bellow
I CHANGED IT, here and everywhere-->

::: notes
Notas.
:::

## Sele√ß√£o de √°rvores {.smaller}

Podemos mapear √°rvores explor√°veis, selecionadas, futuras e de reserva.

```{r harvest}
#| echo: true
base + geom_sf(data = TreeSelection$HarvestableTreesPoints, aes(colour = "Harvestable")) +
  geom_sf(data = TreeSelection$SelectedTreesPoints, aes(colour = "Selected")) +
  geom_sf(data = TreeSelection$FutureTreesPoints, aes(colour = "Future")) +
  geom_sf(data = TreeSelection$ReserveTreesPoints, aes(colour = "Reserve"))
```

::: notes
Notas.
:::

## Trilhas de arraste

As trilhas de arraste permitem que as √°rvores selecionadas sejam colhidas pelas m√°quinas escolhidas. A rota √© otimizada para reduzir a dist√¢ncia percorrida, respeitando as restri√ß√µes topogr√°ficas e evitando as √°rvores a serem protegidas. Elas t√™m 4 metros de largura, com uma inclina√ß√£o m√°xima de 22% e uma inclina√ß√£o lateral m√°xima de 4%. Elas evitam √°rvores a serem cortadas, √°rvores grandes (\>50 cm) e √°rvores de reserva.

::: notes
Notas
:::

## Trilhas de arraste

`secondstrailsopening` permite definir trihlas de arraste.

```{r 2trail}
#| echo: true
#| cache: true
ScndTrailOutputs <- secondtrailsopening(
  topography = DTMParacou,
  plotmask = PlotMask,
  maintrails = MainTrails,
  plotslope = HarvestableArea$PlotSlope,
  harvestablepolygons = HarvestableArea$HarvestablePolygons,
  machinepolygons = HarvestableArea$MachinePolygons,
  treeselectionoutputs = TreeSelection,
  scenario = "manual",
  winching = "2",
  fuel = "0",
  advancedloggingparameters = loggingparameters()
)
inventory <- ScndTrailOutputs$inventory
```

‚ö†Ô∏è Essa etapa pode levar algum tempo.

::: notes
Notas.
:::

## Trilhas de arraste {.smaller}

Podemos mapear as trilhas de arraste com o √°rvores selecionadas.

```{r tracksplot}
#| echo: true
base + geom_sf(data = st_as_sf(SecondaryTrails$SmoothedTrails)) +
  geom_sf(data = TreeSelection$SelectedTreesPoints, aes(colour = "Selected"))
```

::: notes
Notas
:::

## Corte de √°rvores

Em seguida, simulamos o corte da √°rvore. O corte da √°rvore cria uma √°rvore no solo, cujas dimens√µes s√£o calculadas usando alometrias espec√≠ficas.

O corte direcional visa direcionar a queda da √°rvore, com o p√© um √¢ngulo em rela√ß√£o ao caminho, e evitando as √°rvores a serem protegidas.
Mas o corte direcional pode falhar (em 40% dos casos)! 


## Corte de √°rvores

`treefelling` permite que voc√™ simula a corte de √°rvores.

```{r treefelling}
#| echo: true
#| cache: true
inventory <- inventory %>% 
  treefelling(
    scenario = "manual", 
    fuel = "0",
    winching = "2", 
    directionalfelling = "2",
    maintrailsaccess = ScndTrailOutputs$MainTrailsAccess,
    scndtrail = ScndTrailOutputs$SmoothedTrails,
    advancedloggingparameters = loggingparameters()
  )
```

::: notes
Notas.
:::

## Corte de √°rvores {.smaller}

Podemos mapear os √°rvores no solo.

```{r mappost}
#| echo: true
FelledTrees <- getgeometry(inventory, TreePolygon) %>% st_set_crs(crs)
base + geom_sf(data = st_as_sf(SecondaryTrails$SmoothedTrails)) + geom_sf(data = FelledTrees, fill = "lightpink")
```



::: notes
Notas.
:::

## Quantificar de volumes

Por fim, podemos quantificar o volume de madeira colhida de √°rvores saud√°veis usadas para a produ√ß√£o de madeira com `timberharvestedvolume`.

```{r timberv}
#| echo: true
TimberV <- timberharvestedvolume(
  inventory, 
  scenario = "manual", 
  fuel = "0",
  advancedloggingparameters = loggingparameters()
)
TimberV$TimberLoggedVolume
```

::: notes
Notas.
:::

## Quantificar de volumes

Os detalhes da produ√ß√£o por esp√©cie est√£o no invent√°rio.

```{r timbervsp}
#| echo: true
TimberV$inventory %>% 
  filter(DeathCause == "cut") %>% 
  group_by(CommercialName) %>% 
  summarise(
    trees_n = n(), 
    volume = sum(TimberLoggedVolume), 
    CommercialLevel = unique(CommercialLevel)
  )
```

::: notes
Notas.
:::

## Quantificar de volumes

Mas, acima de tudo, podemos quantificar o volume de danos por causa de morte.

```{r degagb}
#| echo: true
TimberV$inventory %>% 
  group_by(DeathCause) %>% 
  summarise(AGB = sum(AGB)) %>% na.omit() %>% 
  ggplot(aes(DeathCause, AGB)) + geom_col() + xlab("")
```

<!-- Actually, if you do it like that you just get the cause of death but not really the volume of damage.
We indeed considered that the unused part of harvested trees are also damage.
So either we keep the graph like that and change the text, or we change the graph to get the actual quantity of damage.
I'm in favour of the second option.

I made a function for that for ManagForRes, I will adapt it for the presentation to practitionners, we can use it here if we decide to go for that.
Note for me; it's in Misc/2211_check_deathtree_fate.Rmd
-->

::: notes
Notas.
:::

# Para saber mais

Algumas informa√ß√µes adicionais para aqueles que desejam ir al√©m com o `LoggingLab`.

::: notes
Notas.
:::

## Uma √∫nica simula√ß√£o {.smaller}

Todas as etapas de simula√ß√£o podem ser inclu√≠das em uma √∫nica fun√ß√£o para economizar tempo.

```{r single}
#| echo: true
#| cache: true
Rslt <- loggingsimulation1(
  Paracou6_2016,
  plotmask = PlotMask, 
  topography = DTMParacou,
  creekverticaldistance = CreekDistances$distvert,
  creekhorizontaldistance = CreekDistances$disthorz,
  speciescriteria = SpeciesCriteria,
  volumeparameters = ForestZoneVolumeParametersTable,
  scenario = "manual",
  objective = 30,
  fuel = "0", 
  winching = "2", 
  directionalfelling = "2", 
  diversification = TRUE, 
  specieslax = FALSE, 
  objectivelax = TRUE,
  crowndiameterparameters = ParamCrownDiameterAllometry,
  advancedloggingparameters = loggingparameters()
)
```

V√°rias simula√ß√µes podem ser executadas pela fun√ß√£o `loggingsimulation()` para levar em conta a estocasticidade com o argumento `iter` (n√∫mero de simula√ß√µes) e `cores` (n√∫mero de n√∫cleos de computador usados para paralelizar o c√°lculo).

::: notes
Notas.
:::

## Resultados

`loggingsummary1` retorna um resumo das sa√≠das da fun√ß√£o de simula√ß√£o.

```{r res}
#| echo: true
try(loggingsummary1(Rslt))
```

::: notes
Notas.
:::

## Cen√°rios

Os cen√°rios re√∫nem os principais par√¢metros de explora√ß√£o. Eles s√£o usados para definir a zona explor√°vel, as √°rvores a serem cortadas e a modelagem de trilhas secund√°rias.

::: notes
Notas.
:::

## Cen√°rios {.smaller}

As colunas do cen√°rio s√£o:

::: incremental
-   `Type`: o nome do cen√°rio
-   `SpatialDataType`: o tipo de dados espaciais (Lidar ou SRTM)
-   `Objective`: o volume objetivo por hectare
-   `Diversification`: por permitir o corte de outras esp√©cies al√©m das principais esp√©cies comerciais
-   `Winching`: o m√©todo de guincho, sem cabo ou garra = ‚Äú0‚Äù, somente cabo = ‚Äú1‚Äù, garra + cabo = ‚Äú2‚Äù
-   `DirectionalFelling`: ‚Äú0‚Äù = n√£o utilizado, ‚Äò1‚Äô = apenas para evitar danos a √°rvores futuras e de reserva, ‚Äò2‚Äô = evitar danos a √°rvores futuras e de reserva + orienta√ß√£o da trilha
:::

Todas as fun√ß√µes permitem `scenario = ‚Äúmanual‚Äù`: nesse caso, todos os argumentos devem ser adicionados manualmente. Seu nome √© o mesmo das colunas.

::: notes
Notas.
:::

## Cen√°rios

`LogingLab` inclui cen√°rios predefinidos que correspondem a diferentes vers√µes de registro de impacto reduzido na Guiana Francesa.

```{r scenarios}
#| echo: true
ScenariosTable
```

## Par√¢metros de explora√ß√£o {.smaller .scrollable}

`loggingparameters()` define todos os par√¢metros de explora√ß√£o. Consulte sua ajuda (`?loggingparameters`). Os valores padr√£o s√£o os usados na Guiana Francesa.

```{r logpars}
#| echo: true
loggingparameters()
```

# Conclus√£o

Parab√©ns üëè , agora voc√™s s√£o profissionais do `LoggingLab`\`!

Falando mais seriamente, ficaremos felizes em responder a quaisquer perguntas que voc√™ possa ter, portanto, n√£o hesite em dar uma olhada no [GitHub](https://github.com/VincyaneBadouard/LoggingLab/issues) para quaisquer d√∫vidas futuras.

::: footer
*Sylvain Schmitt (sylvain.schmitt\@cirad.fr) & G√©raldine Derroire (geraldine.derroire\@cirad.fr)*
:::

::: notes
Notas.
:::

## Refer√™ncias
